<% content_for :browser_title, title_with_success_prefix("Application #{@application_form.support_reference}", flash[:success].present?) %>
<% content_for :title do %>
  <span class="govuk-caption-xl">Application <%= @application_form.support_reference %></span>
  <%= @application_form.full_name %>'s application
<% end %>

<% content_for :before_content do %>
  <%= govuk_back_link_to(support_interface_applications_path, 'Back') %>

  <%= render SubNavigationComponent.new(items: [
    { name: 'Application info', url: support_interface_application_form_path(@application_form), current: true },
    { name: 'History', url: support_interface_application_form_audit_path(@application_form) },
    { name: 'Email log', url: '#' },
    { name: 'Actions', url: support_interface_application_form_actions_path(@application_form) },
  ]) %>
<% end %>

<%= render SupportInterface::ApplicationSummaryComponent.new(application_form: @application_form) %>

<h2 class="govuk-heading-l govuk-!-margin-top-8">Personal details</h2>

<%= render PersonalDetailsComponent.new(application_form: @application_form) %>

<% if @application_form.application_choices.any? %>
  <h2 class="govuk-heading-l govuk-!-margin-top-8">Course choices</h2>
  <% @application_form.application_choices.includes(:course, :provider, :site).each do |application_choice| %>
    <% rows = [
      { key: 'Course', value: application_choice.offered_course.name_and_code },
      { key: 'Provider', value: application_choice.offered_course.provider.name_and_code },
      { key: 'Location', value: application_choice.offered_option.site.name_and_code },
      { key: 'Status', value: render(SupportInterface::ApplicationStatusTagComponent.new(application_choice: application_choice)) },
    ] %>
    <% rows << { key: 'Reason for rejection', value: application_choice.rejection_reason } if application_choice.rejection_reason.present? %>
    <% rows << { key: 'Reject by default at', value: application_choice.reject_by_default_at.to_s(:govuk_date_and_time) } if application_choice.reject_by_default_at %>
    <% rows << { key: 'Decline by default at', value: application_choice.decline_by_default_at.to_s(:govuk_date_and_time) } if application_choice.decline_by_default_at %>

    <%= render SummaryCardComponent.new(rows: rows) do %>
      <%= render SummaryCardHeaderComponent.new(title: application_choice.offered_course.name_and_code) %>
    <% end %>
  <% end %>
<% end %>

<h2 class="govuk-heading-l govuk-!-margin-top-8">References</h2>

<% reference_status = ReferenceStatus.new(@application_form) %>

<% if reference_status.still_more_references_needed? %>
  <p class="govuk-body">
    This candidate needs to provide <%= reference_status.number_of_references_that_currently_need_replacing %> new reference(s).
  </p>
<% end %>

<% if @application_form.application_references.any? %>
  <% @application_form.application_references.each_with_index do |reference, i| %>
    <%= render SupportInterface::ReferenceWithFeedbackComponent.new(reference: reference, title: "#{(i + 1).ordinalize} reference #{reference.replacement? ? '(replacement)' : nil}") %>
  <% end %>
<% end %>

<h2 class="govuk-heading-l govuk-!-margin-top-8" id="qualifications">Qualifications</h2>

<%= render QualificationsComponent.new(application_form: @application_form) %>

<h2 class="govuk-heading-l govuk-!-margin-top-8">Work history</h2>

<%= render WorkHistoryReviewComponent.new(application_form: @application_form, editable: false, heading_level: 3) %>

<h2 class="govuk-heading-l govuk-!-margin-top-8">Unpaid experience and volunteering</h2>

<%= render VolunteeringReviewComponent.new(application_form: @application_form, editable: false, heading_level: 3) %>

<h2 class="govuk-heading-l govuk-!-margin-top-8">Language skills</h2>

<%= render LanguageSkillsComponent.new(application_form: @application_form) %>

<h2 class="govuk-heading-l govuk-!-margin-top-8">Personal statement</h2>

<%= render PersonalStatementComponent.new(application_form: @application_form) %>
